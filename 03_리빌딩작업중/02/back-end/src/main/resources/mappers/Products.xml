<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.backend.dao.ProductDao">
    <!--상품 고유키로 상품 조회-->
    <select id="findById" parameterType="long"
            resultType="com.example.backend.model.Product">
        SELECT ID,
               TITLE,
               MODEL,
               DESCRIPTION,
               PRICE,
               INSERT_TIME,
               CATEGORY,
               DISCOUNT,
               PERCENT,
               SALE_YN,
               NAME,
               TYPE,
               DATA
        FROM TB_PRODUCT
        WHERE ID = #{id}
    </select>

    <!--상품 전체 조회(페이징)-->
    <select id="findAll" parameterType="com.example.backend.paging.ProductCriteria"
            resultType="com.example.backend.model.Product">
        SELECT *
        FROM (SELECT ROWNUM R,
                     TT.*
              FROM TB_PRODUCT TT
              WHERE DELETE_YN = 'N'
                AND ROWNUM &lt;= (#{page} + 1) * #{size})
        WHERE R &gt; #{page} * #{size}
    </select>

    <!--상품 전체 카운트-->
    <select id="selectTotalCount" resultType="int">
        SELECT COUNT(*)
        FROM TB_PRODUCT
        WHERE DELETE_YN = 'N'
          <!--AND TITLE LIKE '%' || #{title} || '%'-->
    </select>

    <!--상품 카테고리별 카운트-->
    <select id="selectCategoryCount" resultType="int">
        SELECT COUNT(*)
        FROM TB_PRODUCT
        WHERE DELETE_YN = 'N'
          AND CATEGORY = #{catId}
    </select>

    <!--세일 상품 카운트-->
    <select id="selectSaleCount" resultType="int">
        SELECT COUNT(*)
        FROM TB_PRODUCT
        WHERE DELETE_YN = 'N'
          AND SALE_YN = #{saleYn}
    </select>

    <!--상품 이름으로 조회-->
    <select id="findByTitleContaining"
            parameterType="com.example.backend.paging.ProductCriteria"
            resultType="com.example.backend.model.Product">
        SELECT *
        FROM (
                 SELECT
                     ROWNUM R, TT.*
                 FROM TB_PRODUCT TT
                 WHERE DELETE_YN = 'N'
                   AND TITLE LIKE '%' || #{title} || '%'
                   AND ROWNUM &lt;= (#{page} + 1) * #{size}
             )
        WHERE R > #{page} * #{size}
    </select>

    <!--상품 카테고리로 조회-->
    <select id="findByCategory"
            parameterType="com.example.backend.paging.ProductCriteria"
            resultType="com.example.backend.model.Product">
        SELECT *
        FROM (
                 SELECT ROWNUM R, TT.*
                 FROM TB_PRODUCT TT
                 WHERE DELETE_YN = 'N'
                   AND CATEGORY = #{catId}
                   AND ROWNUM &lt;= (#{page} + 1) * #{size}
             )
        WHERE R > #{page} * #{size}
    </select>

    <!--세일 상품 조회-->
    <select id="findBySale"
            parameterType="com.example.backend.paging.ProductCriteria"
            resultType="com.example.backend.model.Product">
        SELECT *
        FROM (
                 SELECT ROWNUM R, TT.*
                 FROM TB_PRODUCT TT
                 WHERE DELETE_YN = 'N'
                   AND SALE_YN = 'Y'
                   AND ROWNUM &lt;= (#{page} + 1) * #{size}
             )
        WHERE R > #{page} * #{size}
    </select>

    <!--최근 추가된 상품 조회-->
    <select id="findNewProduct" resultType="com.example.backend.model.Product">
        SELECT *
        FROM (SELECT ROWNUM R, TT.*
              FROM (SELECT *
                    FROM TB_PRODUCT
                    WHERE DELETE_YN = 'N'
                    ORDER BY INSERT_TIME DESC) TT
             )
        WHERE R &lt;= 8
    </select>

    <!--랜덤 상품 조회-->
    <select id="findRandomProduct" resultType="com.example.backend.model.Product">
        SELECT *
        FROM (SELECT *
              FROM TB_PRODUCT
              ORDER BY DBMS_RANDOM.RANDOM())
        WHERE DELETE_YN = 'N'
          AND ROWNUM &lt;= 4
    </select>

    <!--베스트 상품 조회-->
    <select id="findByBestProduct" parameterType="com.example.backend.paging.ProductCriteria"
            resultType="com.example.backend.model.Product">
        SELECT *
        FROM (SELECT ROWNUM R, A.*
              FROM (  SELECT  L.*, P.*
                      FROM (  SELECT PRODUCT_ID, COUNT(USER_ID) AS COUNT
                              FROM TB_LIKE
                              GROUP BY PRODUCT_ID) L,
                           TB_PRODUCT P
                      WHERE L.PRODUCT_ID = P.ID
                      ORDER BY COUNT DESC) A)
        WHERE R &lt;= #{rowNum}
    </select>

    <!--랜덤 상품 이미지 조회-->
    <select id="findRandomProductImg" resultType="com.example.backend.model.Product">
        SELECT *
        FROM (SELECT *
              FROM TB_PRODUCT
              ORDER BY DBMS_RANDOM.RANDOM())
        WHERE DELETE_YN = 'N'
          AND ROWNUM &lt;= 5
    </select>

    <!--상품 등록-->
    <insert id="save" parameterType="com.example.backend.model.Product">
        INSERT INTO TB_PRODUCT (
            ID,
            CATEGORY,
            TITLE,
            MODEL,
            DESCRIPTION,
            PRICE,
            DISCOUNT,
            PERCENT,
            SALE_YN,
            INSERT_TIME,
            TYPE,
            DATA
        ) VALUES (
            SQ_PRODUCT.NEXTVAL,
            #{category},
            #{title},
            #{model},
            #{description},
            #{price},
            #{discount},
            #{percent},
            #{saleYn},
            TO_CHAR(SYSDATE + 9 / 24, 'YYYY-MM-DD HH24:MI:SS'),
            #{type},
            #{data}
        )
    </insert>

    <!--상품 삭제-->
    <update id="deleteProduct" parameterType="Long">
        UPDATE TB_PRODUCT
        SET
            DELETE_YN = 'Y'
          ,DELETE_TIME = TO_CHAR(SYSDATE + 9 / 24, 'YYYY-MM-DD HH24:MI:SS')
        WHERE
            ID = #{id}
    </update>

    <!--상품 수정-->
    <update id="updateProduct"
            parameterType="com.example.backend.model.Product">
        UPDATE TB_PRODUCT
        SET CATEGORY = #{category},
            TITLE = #{title},
            MODEL = #{model},
            DESCRIPTION = #{description},
            PRICE = #{price},
            DISCOUNT = #{discount},
            PERCENT = #{percent},
            SALE_YN = #{saleYn},
            UPDATE_TIME = TO_CHAR(SYSDATE + 9 / 24, 'YYYY-MM-DD HH24:MI:SS')
        WHERE
            ID = #{id}
    </update>

    <!--상품 전체 삭제-->
    <update id="deleteAll">
        UPDATE TB_PRODUCT
        SET DELETE_YN = 'Y',
            DELETE_TIME = TO_CHAR(SYSDATE + 9 / 24, 'YYYY-MM-DD HH24:MI:SS')
    </update>

</mapper>
















